# study-go-microsystem

## 方針

本プロジェクトは、公開用ではなく、Goの理解をするためのプロジェクトのため、
Go由来の命名規則やディレクトリ構造などは省いております。

また、さまざまなパターンに対応可能にするため、必要以上にDIやインターフェースでの構造を構築し、
テストがかけるという部分に重点を置いております。

## 現時点の進捗

認証側
csrf の発行・認証
ログイン jwtの発行
リフレッシュトークンによる、jwtの再発行
新規登録処理
まで完了

9/16
github.com/stretchr/testify/mock を追加して、mock注入を容易にしてテストを書きやすくした

9/23
ディレクトリ構成を調整し、chat側の構築を開始、mongoとの接続を確立させ、ルーム作成まで完了
テスト構築可能な構造にはおおよそしてあるが、現時点ではおそらく不十分なので、次回は
この部分のテストを書きながら調整を行う

9/29
mongo周りのテストを追加

10/1
internal配下のテストを実装一旦カバレッジは100％
次回以降は実装部分を仕上げていく

10/2
チャットルームへの参加機能を実装
テスト込みで1時間程度で実装可能になった。
だいぶ慣れてきたみたいで良き

10/5
チャットルーム一覧の取得処理を実装
複雑なモックやラッパーも含めだいぶスルスル書けるようになった

10/6
チャットの投稿機能実装
テストを含め45分程度で実装ができたの良き

10/8
チャット一覧取得機能実装
テスト含め30分程度で実装完了
過去に実装した、join処理やroom一覧の処理を参考にしたが、
それでも、このペースで書けていれば良い方なのかな

10/9
チャット既読機能
一括でmongoを更新する処理を記述

10/14
チャット削除機能
テストのモックがかなり肥大化してきたので、そろそろモックのファクトリーを作って共通化を考えた方が良さそう
E2Eのテストもそろそろ検討しても良いかも

10/15
テストの共通化
テストがかなり同じ処理をしていたので、共通化を行なってファイルのダイエットを行なった
カバレッジは100％の状態で約４００行の削減に成功

## 失敗談
9/7 
gormのインサート部分のテストを実装
gormは設定で自動トランザクションを無効化しておかないと、自動でトランザクションが貼られてしまうことが判明
テストの時にトランザクション句を指定することで、テストが通るようになったけど、
そもそも `mock.ExpectExec("INSERT INTO .*users.*").` が通る前の Begin区で落ちていたので、
モックのログにクエリが出てこなかった。
モデル生成時に0001-01-01 が原因だと決めつけて処理していたことで大幅に時間を取られてしまった。
今回のような事象で詰まった際には、`fmt.Printf("🔥 result.Error = %v\n", result.Error)` このような形で、エラーを出すなりして、
確認する。（マジで時間の無駄だった、、、反省）

9/23
main.go 内は go run main.goが実行されたタイミングで呼ばれているため、
リクエストごとに何かしらの制御をしたい場合は、handler以降で処理をしないと、
呼び出しされない。
mongoとの接続処をDIの関係で、mainで行なっていたが、これだとタイムアウトしてしまうため、
初期接続はmain リクエストによる実行時に再接続を行う形で対応
これにより、DIを維持しつつ、再接続でタイムアウトまでの時間がリセットされるため、
正常に動作する

9/28
責務の分離が甘すぎたため、mongoがDIできない構造になってしまっていた。
もう少し、テストを考慮してDIができる構造を意識する必要がある。
今回は、接続部分をパッケージに分離し、サービス層でパッケージを呼び出し更新をかける構造に変更。
おそらく、このあと、パッケージ側のテスト構築時に新たな問題は発生しそうだが、取り急ぎHandlerはテストが書ける構造になった。

9/29
エラーの見方がまだ、よく理解しきれていない、

```
panic: interface conversion: *mongo_svc.MongoCollectionMock is not mongo_pkg.MongoCollectionInterface: missing method InsertOne [recovered]
```

この辺のインターフェースの定義ずれのエラーをすぐに見抜けない状況なので、数をこなして、行く必要がある
